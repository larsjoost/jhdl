#!/bin/bash

SCRIPT=$(realpath $0)
SCRIPTPATH=$(dirname $SCRIPT)

function error {
    local message=$1
    echo "[ERROR] $SCRIPT: $message" 1>&2
}


usage()
{
    cat << EOF
Command: $0 $ALL_ARGUMENTS

Generates dependency files of FILES
	  
usage: $0 [OPTIONS] FILES

OPTIONS:
   -h           Show this message
   -l <name>    Library name
   -v           Verbose 
EOF
}

while getopts ":hl:v" OPTION
do
    case $OPTION in
        h)
            usage
            exit 0
            ;;
        l)
            LIBRARY="-l $OPTARG"
            ;;
        v)
            VERBOSE="-v"
	    set -x
            ;;
        ?)
            echo "Unknown option $OPTARG"
            usage
            exit 1
            ;;
        :)
            echo "No argument value for option $OPTARG"
            usage
            exit 1
            ;;
    esac
done

shift "$((OPTIND-1))"

for i in "$@"; do
    x=$(find $DIR -name $(basename $i))
    if [ -z "$x" ]; then
	error "Could not find file $i"
	exit 1
    fi
    files="$files $x"
done

PYTHON_SCRIPT_PATH=$SCRIPTPATH/../scripts

mkdir -p cmake

function get_element {
    local text="$1"
    local element=$2
    python -c "a = \"$text\"; print(a.split(',')[$element])"
}

function exists_in_list {
    list=$1
    find=$2
    echo "$1" | grep "$find"
}

for i in $(echo "$files"); do
    hdle -e "%t,%l,%u" $i | python $PYTHON_SCRIPT_PATH/parse_expression.py $VERBOSE -c $SCRIPTPATH/../config/jhdl.conf -f $i -e "type,library,unit"
done
